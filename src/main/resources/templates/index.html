<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>driMain - Raporty Utrzymania Ruchu</title>
    <!-- Bootstrap 5 CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" />
    <!-- Font Awesome (ikony) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
    <!-- Twój własny CSS (opcjonalnie) -->
    <link rel="stylesheet" th:href="@{/css/style.css}" />
</head>
<body class="bg-dark text-light">

<div class="container py-4">

    <h1 class="mb-4"><i class="fas fa-cogs"></i> driMain - Raporty Utrzymania Ruchu</h1>

    <!-- Sekcja logowania (widoczna tylko gdy nie zalogowany) -->
    <div th:if="!${isAdmin}" class="mb-3">
        <a href="/login" class="btn btn-success me-2"><i class="fas fa-sign-in-alt"></i> Zaloguj jako admin</a>
        <button onclick="userLogin()" class="btn btn-info"><i class="fas fa-user"></i> Zaloguj jako użytkownik</button>
    </div>

    <!-- Sekcja dla zalogowanych (jak wcześniej) -->
    <div class="mb-3" th:if="${isAdmin}">
        <a href="/raport/nowy" class="btn btn-primary me-2"><i class="fas fa-plus"></i> Nowy raport</a>
        <a href="/admin" class="btn btn-secondary me-2"><i class="fas fa-tools"></i> Panel Admina</a>
        <a href="/logout" class="btn btn-danger"><i class="fas fa-sign-out-alt"></i> Wyloguj</a>
    </div>

    <table class="table table-dark table-striped table-hover">
        <thead>
        <tr>
            <th>ID</th>
            <th>Maszyna (Dział)</th>
            <th>Typ Naprawy</th>
            <th>Opis</th>
            <th>Kto Naprawił</th>
            <th>Status</th>
            <th>Data</th>
            <th>Czas (od-do)</th>
            <th th:if="${isAdmin}">Akcje</th>
        </tr>
        </thead>
        <tbody>
        <tr th:each="raport : ${raporty}">
            <td th:text="${raport.id}"></td>
            <td th:text="${raport.maszyna != null ? raport.maszyna.nazwa + ' (' + (raport.maszyna.dzial != null ? raport.maszyna.dzial.nazwa : 'Brak działu') + ')' : 'Brak maszyny'}"></td>
            <td th:text="${raport.typNaprawy}"></td>
            <!-- Kolumna Opis ze skrótem i przyciskiem "Rozwiń" -->
            <td>
                <!-- Krótki fragment opisu -->
                <span th:text="${#strings.length(raport.opis) > 50} ? ${#strings.substring(raport.opis, 0, 50)} + '...' : ${raport.opis}"></span>
                <!-- Przyciski "Rozwiń" -->
                <a th:if="${#strings.length(raport.opis) > 50}"
                   href="#"
                   data-bs-toggle="modal"
                   data-bs-target="#opisModal"
                   th:data-full="${raport.opis}"
                   class="btn btn-sm btn-link"><i class="fas fa-plus"></i> Rozwiń</a>
            </td>
            <td th:text="${raport.osoba != null ? raport.osoba.imieNazwisko : 'Brak osoby'}"></td>
            <td th:text="${raport.status}"></td>
            <td th:text="${raport.dataNaprawy}"></td>
            <td th:text="${raport.czasOd} + ' - ' + ${raport.czasDo}"></td>
            <td th:if="${isAdmin}">
                <a th:href="@{/raport/edytuj/{id}(id=${raport.id})}" class="btn btn-warning btn-sm me-1"><i class="fas fa-edit"></i> Edytuj</a>
                <button th:onclick="|confirmDelete(${raport.id})|" class="btn btn-danger btn-sm"><i class="fas fa-trash"></i> Usuń</button>
            </td>
        </tr>
        </tbody>
    </table>

</div>

<!-- Modal do pełnego opisu -->
<div class="modal fade" id="opisModal" tabindex="-1" aria-labelledby="opisModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content bg-dark text-light">
            <div class="modal-header">
                <h5 class="modal-title" id="opisModalLabel"><i class="fas fa-info-circle"></i> Pełny opis zdarzenia</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Zamknij"></button>
            </div>
            <div class="modal-body" id="fullOpis" style="white-space: pre-wrap;">
                <!-- Pełny opis zostanie tutaj wstawiony dynamicznie -->
            </div>
        </div>
    </div>
</div>

<!-- Bootstrap JS i Popper -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<!-- Skrypt do dynamicznego wstawiania pełnego opisu -->
<script>
    document.addEventListener('DOMContentLoaded', () => {
        var opisModal = document.getElementById('opisModal');
        var fullOpis = document.getElementById('fullOpis');

        opisModal.addEventListener('show.bs.modal', function (event) {
            const button = event.relatedTarget;
            const fullText = button.getAttribute('data-full');
            fullOpis.innerText = fullText;

            // Ustaw szerokość modala na podstawie długości tekstu
            // (np. minimalna szerokość, lub na podstawie długości tekstu)
            const modalDialog = opisModal.querySelector('.modal-dialog');

            // Możesz ustawić szerokość na np. 80% lub na podstawie długości tekstu
            modalDialog.style.maxWidth = '600px'; // albo '80%'
        });

    });
</script>

<!-- Skrypt do potwierdzenia usuwania raportu -->
<script>
    function confirmDelete(raportId) {
        if (confirm("Czy na pewno chcesz usunąć ten raport? Tej operacji nie można cofnąć!")) {
            window.location.href = "/raport/usun/" + raportId;
        }
    }
</script>

<!-- Skrypt dla logowania użytkownika (placeholder) -->
<script>
    function userLogin() {
        alert("Logowanie dla zwykłego użytkownika nie jest jeszcze zaimplementowane. Skontaktuj się z adminem.");
        // Tu możesz dodać przekierowanie do osobnego formularza, np. window.location.href = "/user-login";
        function confirmDelete(raportId) {
            console.log("Wywołano confirmDelete z ID:", raportId); // Sprawdź, czy ID jest poprawne
            if (confirm("Czy na pewno chcesz usunąć ten raport? Tej operacji nie można cofnąć!")) {
                console.log("Przekierowuję na /raport/usun/" + raportId);
                window.location.href = "/raport/usun/" + raportId;
            }
        }

    }
</script>
<script>
    document.addEventListener('DOMContentLoaded', () => {
        document.querySelectorAll('.delete-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const raportId = this.getAttribute('data-raport-id');
                confirmDelete(raportId);
            });
        });
    });

</script>


</body>
</html>
